!function(e){function t(e){var t={},r={type:"contentType",name:"query",withParents:"withParent"};e.parentType&&e.parentId&&(t[e.parentType+"Id"]=e.parentId);for(var a in e)n(e,a)&&e[a]&&(t[n(r,a)?r[a]:a]=e[a]);return t}function n(e,t){return e.hasOwnProperty(t)}function r(e){var t=window.console;t&&t.error&&t.error(e)}e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.typeCode={city:1,settlement:2,village:4},e.kladr.validate=function(t){var n=e.kladr.type;switch(t.type){case n.region:case n.district:case n.city:if(t.parentType&&!t.parentId)return r("parentId undefined"),!1;break;case n.street:if(t.parentType!=n.city)return r('parentType must equal "city"'),!1;if(!t.parentId)return r("parentId undefined"),!1;break;case n.building:if(!t.zip){if(t.parentType!=n.street)return r('parentType must equal "street"'),!1;if(!t.parentId)return r("parentId undefined"),!1}break;default:if(!t.oneString)return r("type incorrect"),!1}return t.oneString&&t.parentType&&!t.parentId?(r("parentId undefined"),!1):t.typeCode&&t.type!=n.city?(r('type must equal "city"'),!1):t.limit<1?(r("limit must greater than 0"),!1):!0},e.kladr.api=function(n,a){if(!a)return void r("Callback undefined");if(!e.kladr.validate(n))return void a([]);var i=setTimeout(function(){a([]),i=null},3e3);e.getJSON(e.kladr.url+"?callback=?",t(n),function(e){i&&(a(e.result||[]),clearTimeout(i))})},e.kladr.check=function(t,n){return n?(t.withParents=!1,t.limit=1,void e.kladr.api(t,function(e){n(e&&e.length?e[0]:!1)})):void r("Callback undefined")}}(jQuery),function(e,t){function n(t,n){function r(e,t){return e.isGet?d.get(e.str[0]):(d.set(e),void t())}var d=function(){var n="kladr-data",r=t.data(n);return r||(r=e.extend({},o,l),t.data(n,r)),{set:function(e){if(e.obj)for(var a in e.obj)i(e.obj,a)&&i(o,a)&&(r[a]=e.obj[a]);else e.str&&!e.isGet&&i(o,e.str[0])&&(r[e.str[0]]=e.str[1]);t.data(n,r)},get:function(e){return i(o,e)||i(l,e)?r[e]:void 0},_set:function(e,a){r[e]=a,t.data(n,r)},_get:function(e){return i(r,e)?r[e]:void 0}}}();return r(n,function(){function n(n){var r=e(document.getElementById("kladr_autocomplete"));r.length||(r=e('<div id="kladr_autocomplete"></div>').appendTo(document.body));var i=S("guid");i?(_=r.find(".autocomplete"+i),B=r.find(".spinner"+i),e(window).off(P),t.off(P),_.off(P)):(i=a(),j("guid",i),t.attr("autocomplete","off"),_=e('<ul class="autocomplete'+i+' autocomplete" style="display: none;"></ul>').appendTo(r),B=e('<div class="spinner'+i+' spinner" style="display: none;"></div>').appendTo(r),y(),o(),h()),n()}function r(t,n){var r,a,o,l;_.empty();for(var u in t)i(t,u)&&(r=t[u],a=S("valueFormat")(r,n),o=S("labelFormat")(r,n),l=e('<a data-val="'+a+'">'+o+"</a>"),l.data("kladr-object",r),e("<li></li>").append(l).appendTo(_))}function o(){var e=t.offset(),n=t.outerWidth(),r=t.outerHeight();if(o.top!=e.top||o.left!=e.left||o.width!=n||o.height!=r){o.top=e.top,o.left=e.left,o.width=n,o.height=r,_.css({top:e.top+r+"px",left:e.left});var a=_.outerWidth()-_.width();_.width(n-a);var i=B.width(),l=B.height();B.css({top:e.top+(r-l)/2-1,left:e.left+n-i-2})}}function l(n){if(!(n.which>8&&n.which<46)){if(!k("open_before"))return void s();T(null);var a=t.val();if(!e.trim(a))return C(!1),void s();var i=b(a);if(!k("send_before",i))return void s();g(),k("send"),S("source")(i,function(n){return k("receive"),t.is(":focus")?e.trim(t.val())&&n.length?(r(n,i),o(),m(),_.slideDown(50),void k("open")):(m(),T(null),void s()):(m(),void s())})}}function s(){k("close_before")&&(_.empty().hide(),k("close"))}function c(e){var t=_.find("li.active");switch(e.which){case u.up:t.length?(t.removeClass("active"),t.prev().length&&(t=t.prev())):t=_.find("li").last(),function(){var e=_.scrollTop(),n=_.offset(),r=t.outerHeight(),a=t.offset();a.top-n.top<0&&_.scrollTop(e-r)}(),t.addClass("active"),p();break;case u.down:t.length?(t.removeClass("active"),t.next().length&&(t=t.next())):t=_.find("li").first(),function(){var e=_.scrollTop(),n=_.height(),r=_.offset(),a=t.outerHeight(),i=t.offset();i.top-r.top+a>n&&_.scrollTop(e+a)}(),t.addClass("active"),p();break;case u.enter:s()}}function f(){var n=e(this);return n.is("a")&&(n=n.parents("li")),n.addClass("active"),p(),s(),t.focus(),!1}function p(){if(k("select_before")){var e=_.find(".active a");e.length&&(t.val(e.attr("data-val")),C(!1),T(e.data("kladr-object")),k("select",S("current")))}}function v(){function n(e,t){C(t),T(e)}if(S("verify")&&k("check_before")){var r=e.trim(t.val());if(!r)return n(null,!1),void k("check",null);if(S("current"))return void C(!1);var a=b(r);if(a.withParents=!1,a.limit=10,!k("send_before",a))return n(null,!1),void k("check",null);g(),k("send"),S("source")(a,function(r){function o(e,t){m(),n(e,t)}if(k("receive"),!e.trim(t.val()))return void o(null,!1);var l=a.name.toLowerCase(),u=null,d=null;for(var s in r)if(i(r,s)&&(u=r[s].name.toLowerCase(),l==u)){d=r[s];break}d&&t.val(S("valueFormat")(d,a)),o(d,!d),k("check",d)})}}function y(){function n(e,n){t.val(e?S("valueFormat")(e,n):""),T(e)}var r={setValue:function(t){return"object"===e.type(t)?r.setValueByObject(t):"number"===e.type(t)?r.setValueById(t):"string"===e.type(t)?r.setValueByName(t):t?r:r.clear()},setValueByName:function(t){if(t=e.trim(t+"")){var a=b("");if(a.name=I(t),a.withParents=!1,a.limit=10,!k("send_before",a))return n(null,a),r;k("send"),S("source")(a,function(e){k("receive");var t=a.name.toLowerCase(),r=null,o=null;for(var l in e)if(i(e,l)&&(r=e[l].name.toLowerCase(),t==r)){o=e[l];break}n(o,a)})}return r},setValueById:function(t){var a=b("");return a.parentType=a.type,a.parentId=t,a.limit=1,e.kladr.api(a,function(e){e.length&&n(e[0],a)}),r},setValueByObject:function(e){return n(e,b("")),r},clear:function(){return n(null,null),r}};j("controller",r)}function h(){function e(){return t.val()?(v(),!!S("current")):!1}var n=0,r=e()||setInterval(function(){(++n>5||e())&&clearInterval(r)},100)}function k(n,r){if(!n)return!0;var a=n.replace(/_([a-z])/gi,function(e,t){return t.toUpperCase()});return t.trigger("kladr_"+n,r),"function"===e.type(S(a))?S(a).call(t.get(0),r)!==!1:!0}function g(){S("spinner")&&S("showSpinner")(B)}function m(){S("spinner")&&S("hideSpinner")(B)}function b(e){var t,n={token:S("token"),key:S("key"),type:S("type"),typeCode:S("typeCode"),name:I(e),parentType:S("parentType"),parentId:S("parentId"),oneString:S("oneString"),withParents:S("withParents"),limit:S("limit")},r=S("parentInput");return n.oneString&&(n.withParents=!0),r&&(t=w(r,n.type),t&&(n.parentType=t.type,n.parentId=t.id)),n}function w(t,n){var r,a=e.kladr.getInputs(t),o=e.kladr.type,l={},u=null;a.each(function(){var t,n=e(this);(t=n.attr("data-kladr-id"))&&(l[n.attr("data-kladr-type")]=t)});for(r in o){if(r==n)return u;i(o,r)&&l[r]&&(u={type:r,id:l[r]})}return u}function I(e){for(var t="abcdefghijklmnopqrstuvwxyz",n=e.toLowerCase(),r=0;r<n.length;r++)if(~t.indexOf(n[r]))return C(!0),e;return C(!1),e}function T(e){j("current",e),e&&e.id?t.attr("data-kladr-id",e.id):t.removeAttr("data-kladr-id"),S("oneString")&&e&&e.contentType&&t.attr("data-kladr-type",e.contentType)}function C(e){e?t.addClass("kladr-error"):t.removeClass("kladr-error")}function S(e){return d._get(e)}function j(e,t){d._set(e,t)}var _=null,B=null,P=".kladr";n(function(){var n=!1;t.attr("data-kladr-type",S("type")||"").attr("data-kladr-one-string",S("oneString")||null).on("keyup"+P,l).on("keydown"+P,c).on("blur"+P+" change"+P,function(){n||(v(),s())}),_.on("touchstart"+P+" click"+P,"li, a",function(){n=!0,f.call(this),n=!1}).on("mouseenter"+P,function(){n=!0}).on("mouseleave"+P,function(){n=!1}),e(window).on("resize"+P,o)})})}function r(n){var r={obj:!1,str:!1,isGet:!1};return"object"===e.type(n)?(r.obj=n,r):("string"===e.type(n)&&(r.str=arguments,r.isGet=arguments[1]===t),r)}function a(){return a.guid?++a.guid:a.guid=1}function i(e,t){return e.hasOwnProperty(t)}var o={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(t,n){e.kladr.api(t,n)},labelFormat:function(t,n){var r;if(n.oneString)return t.parents?(r=e.extend(!0,[],t.parents),r.push(t),e.kladr.buildAddress(r)):(t.typeShort?t.typeShort+". ":"")+t.name;var a,i,o,l,u="";return t.typeShort&&(u+=t.typeShort+". "),a=t.name,i=a.toLowerCase(),o=n.name.toLowerCase(),l=i.indexOf(o),l=~l?l:0,o.length<i.length?(u+=a.substr(0,l),u+="<strong>"+a.substr(l,o.length)+"</strong>",u+=a.substr(l+o.length)):u+="<strong>"+a+"</strong>",u},valueFormat:function(t,n){var r;return n.oneString?t.parents?(r=e.extend(!0,[],t.parents),r.push(t),e.kladr.buildAddress(r)):(t.typeShort?t.typeShort+". ":"")+t.name:t.name},showSpinner:function(e){var t=-.2,n=setInterval(function(){return e.is(":visible")?(e.css("background-position","0% "+t+"%"),t+=5.555556,void(t>95&&(t=-.2))):(clearInterval(n),void(n=null))},30);e.show()},hideSpinner:function(e){e.hide()}},l={current:null,controller:null},u={up:38,down:40,enter:13};e.kladr=e.extend(e.kladr,{setDefault:function(e,t){var n=r(e,t);if(n.obj)for(var a in n.obj)i(o,a)&&(o[a]=n.obj[a]);else n.str&&!n.isGet&&i(o,n.str[0])&&(o[n.str[0]]=n.str[1])},getDefault:function(e){return i(o,e)?o[e]:void 0},getInputs:function(t){var n=e(t||document.body),r="[data-kladr-type]";return n.filter(r).add(n.find(r))},getAddress:function(t,n){var r,a=e.kladr.getInputs(t),o=e.kladr.type,l={},u={};a.each(function(){var t,n,r,a=e(this);if(a.attr("data-kladr-id"))if(t=a.kladr("current"),a.attr("data-kladr-one-string")&&t.parents){n=e.extend(!0,[],t.parents),n.push(t);for(r in n)i(n,r)&&(l[n[r].contentType]=n[r])}else l[a.attr("data-kladr-type")]=t;else l[a.attr("data-kladr-type")]=a.val()});for(r in o)i(o,r)&&l[r]&&(u[r]=l[r]);return(n||e.kladr.buildAddress)(u)},buildAddress:function(t){var n,r,a=[],o="",l="",u="",d="";e:for(n in t)if(i(t,n)){if("object"===e.type(t[n])){for(r=0;r<a.length;r++)if(a[r]==t[n].id)continue e;a.push(t[n].id),u=t[n].name,d=t[n].typeShort+". ",l=t[n].zip||l}else u=t[n],d="";o&&(o+=", "),o+=d+u}return o=(l?l+", ":"")+o}}),e.fn.kladr=function(t,a){var i=r(t,a),o=null;return this.each(function(){var t=n(e(this),i);return i.isGet?(o=t,!1):void 0}),i.isGet?o:this}}(jQuery),function(e){e.fn.kladrZip=function(t){var n=e(t||document.body);return this.keydown(function(t){var n=t.charCode||t.keyCode||0,r=8==n||9==n||13==n||46==n||110==n||190==n||n>=35&&40>=n||n>=96&&105>=n;return e(this).val().length>=6?r:r||n>=48&&57>=n}),this.keyup(function(){function t(e){e?r.addClass("kladr-error"):r.removeClass("kladr-error")}var r=e(this),a=r.val();return a?void e.kladr.api({type:e.kladr.type.building,zip:a,withParents:!0,limit:1},function(r){var a,i,o=r.length&&r[0];if(r=[],o){t(!1),o.parents&&(r=e.extend(!0,[],o.parents)),r.push(o);for(a in r)r.hasOwnProperty(a)&&(i=n.find('[data-kladr-type="'+r[a].contentType+'"]'),i.kladr("controller").setValueByObject(r[a]))}else t(!0)}):void t(!1)}),this}}(jQuery);